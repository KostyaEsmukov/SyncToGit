var c_inkmlNS="http://www.w3.org/2003/InkML",c_xmlNS="http://www.w3.org/XML/1998/namespace",c_xmlnsNS="http://www.w3.org/2000/xmlns/";function isDigit(t){if(1<t.length)return!1;return-1!="1234567890".indexOf(t)}$(document).ready(function(){$(this).find("canvas").each(function(){var i=$(this).get(0),t=$(this).attr("data-inkml-src");if(t){var r=$(this).attr("data-inkml-ignorePressure");$.get(t,{},function(t,e,n){new Ink(t).draw(i,r)})}$(this).attr("data-inkml-trg")&&(new Ink).initForCapture(i)})}),Ink=function(t,e){this.init(t,e)},$.extend(Ink.prototype,{init:function(t,e){if(this.contexts={},this.brushes={},this.traces={},this.mins=[],this.maxs=[],this.sums=[],this.count=0,this.deltas=[],this.ctx=null,e=e||{},this.keepOffsets=e.keepOffsets||!1,this.dpi=e.dpi||150,null!=t){var i=this;$(t).find("inkml\\:context, context").each(function(){var t=$(this).attr("xml:id");if(null==t&&(t=$(this).attr("id")),null==t||(t="#"+t),t){var e=new InkContext($(this),i.dpi);i.contexts[t]=e}}),$(t).find("inkml\\:brush, brush").each(function(){var t=new InkBrush($(this)),e=$(this).attr("xml:id");if(null==e&&(e=$(this).attr("id")),null==e||""==e){var n=0;for(k in i.brushes)i.brushes.hasOwnProperty(k)&&n++;e="brush#"+n.toString()}else e="#"+e;i.brushes[e]=t}),$(t).find("inkml\\:trace, trace").each(function(){var t=new InkTrace(i,$(this)),e=$(this).attr("xml:id");if(null==e&&(e=$(this).attr("id")),null==e||""==e){var n=0;for(k in i.traces)i.traces.hasOwnProperty(k)&&n++;e="trace#"+n.toString()}else e="#"+e;i.traces[e]=t})}},toInkML:function(){var r=document.implementation.createDocument(c_inkmlNS,"inkml:ink",null),t=r.createAttributeNS(c_xmlnsNS,"xmlns:xml");t.nodeValue=c_xmlNS,r.documentElement.setAttributeNode(t);var s=r.createElementNS(c_inkmlNS,"inkml:definitions");return r.documentElement.appendChild(s),$.each(this.contexts,function(t,e){var n=e.toInkML(r),i=r.createAttributeNS(c_xmlNS,"xml:id");i.nodeValue=t.substr(1),n.setAttributeNode(i),s.appendChild(n)}),$.each(this.brushes,function(t,e){var n=e.toInkML(r),i=r.createAttributeNS(c_xmlNS,"xml:id");i.nodeValue=t.substr(1),n.setAttributeNode(i),s.appendChild(n)}),$.each(this.traces,function(t,e){var n=e.toInkML(r);if("number"!=typeof t){var i=r.createAttributeNS(c_xmlNS,"xml:id");i.nodeValue=t.substr(1),n.setAttributeNode(i)}r.documentElement.appendChild(n)}),r},getPixelWidth:function(){var n=this,i=1,r=1e100;$.each(n.contexts,function(t,e){i=Math.max(i,Math.ceil(n.maxs[0]*e.xFactor)),r=Math.min(r,Math.ceil(n.mins[0]*e.xFactor))});var t=i;return n.keepOffsets||(t-=r),t},getPixelHeight:function(){var n=this,i=1,r=1e100;$.each(n.contexts,function(t,e){i=Math.max(i,Math.ceil(n.maxs[1]*e.yFactor)),r=Math.min(r,Math.ceil(n.mins[1]*e.yFactor))});var t=i;return n.keepOffsets||(t-=r),t},clear:function(t){null!=t.getContext?t.getContext("2d").clearRect(0,0,t.width,t.height):alert("error: couldn't get context on canvas")},draw:function(t,p){var d=this;if(null!=t.getContext){var k=t.getContext("2d");$.each(this.traces,function(t,e){k.save();var n=d.contexts[e.contextRef];k.scale(n.xFactor,n.xFactor);var i=null;if(null!=e.brushRef?null==(i=d.brushes[e.brushRef])&&alert("error: brush with xml:id='"+e.brushRef+"' not found."):n.brush&&(i=n.brush),null!=i){k.strokeStyle=i.color,k.lineCap="round",k.lineJoin="round";var r=HiMetricToPixel(i.width,d.dpi);k.lineWidth=10*r}k.beginPath();for(var s=0;s<e.value.length;s++)if(0==s){if(p){var a=e.value[s][0],o=e.value[s][1];d.keepOffsets||(a-=d.mins[0],o-=d.mins[1]),k.moveTo(a,o)}}else if(p){a=e.value[s][0],o=e.value[s][1];d.keepOffsets||(a-=d.mins[0],o-=d.mins[1]),k.lineTo(a,o)}else{var u=e.value[s-1][0],l=e.value[s-1][1],h=e.value[s][0],c=e.value[s][1];if(d.keepOffsets||(u-=d.mins[0],l-=d.mins[1],h-=d.mins[0],c-=d.mins[1]),i){var m=i.width,f=(e.value[s-1][2]+e.value[s][2])/2;if(f){d.sums[2],d.count;f-=n.fNeutral,m+=m*(f*=n.fFactor)}r=HiMetricToPixel(m,d.dpi);k.lineWidth=10*r}k.moveTo(u,l),k.lineTo(h,c),k.stroke()}p&&k.stroke(),k.restore()})}else alert("error: couldn't get context on canvas")},initForCapture:function(t){var e=this;$(t).bind("mousedown",function(t){e.onMouseDown(t)}),$(t).bind("mousemove",function(t){e.onMouseMove(t)}),$(t).bind("mouseup",function(t){e.onMouseUp(t)})},pushCoord:function(t){},onMouseDown:function(t){var e=t.target;$.browser.msie&&e.setCapture(),this.ctx=e.getContext("2d"),this.ctx.beginPath(),this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=2,t.offsetX||(t.offsetX=t.layerX-$(t.target).position().left),t.offsetY||(t.offsetY=t.layerY-$(t.target).position().top),this.ctx.moveTo(t.offsetX,t.offsetY),this.pushCoord(t)},onMouseMove:function(t){this.ctx&&(t.offsetX||(t.offsetX=t.layerX-$(t.target).position().left),t.offsetY||(t.offsetY=t.layerY-$(t.target).position().top),this.ctx.lineTo(t.offsetX,t.offsetY),this.ctx.stroke(),this.pushCoord(t))},onMouseUp:function(t){if(this.ctx){var e=t.target;$.browser.msie&&e.releaseCapture(),t.offsetX||(t.offsetX=t.layerX-$(t.target).position().left),t.offsetY||(t.offsetY=t.layerY-$(t.target).position().top),this.ctx.lineTo(t.offsetX,t.offsetY),this.ctx.stroke(),this.pushCoord(t),this.ctx=null}}}),InkContext=function(t,e){this.init(t,e)},$.extend(InkContext.prototype,{init:function(t,e){this.inkSource=null,this.brush=null,this.timestamp=null,this.xFactor=1,this.yFactor=1,this.fFactor=1,this.fNeutral=.5,this._dpi=e;var n=this,i=$(t).find("inkml\\:inkSource, inkSource");if(i.length){n.inkSource=new InkSource(i);var r=n.inkSource.traceFormat.channels.X,s=n.inkSource.traceFormat.channels.Y,a=UnitsToHiMetric(1/r.resolution,r.units),o=UnitsToHiMetric(1/s.resolution,s.units);n.xFactor=HiMetricToPixel(a,n._dpi),n.yFactor=HiMetricToPixel(o,n._dpi);var u=n.inkSource.traceFormat.channels.F;u&&(n.fFactor=1/(u.max-u.min),n.fNeutral=(u.max-u.min)/2)}var l=$(t).find("inkml\\:brush, brush");l.length&&(n.brush=new InkBrush(l));var h=$(t).find("inkml\\:timestamp, timestamp");h.length&&(this.timestamp=new InkTimestamp(h))},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:context");if(this.inkSource){var n=this.inkSource.toInkML(t);e.appendChild(n)}if(this.timestamp){var i=this.timestamp.toInkML(t);e.appendChild(i)}return e}}),InkSource=function(t){this.init(t)},$.extend(InkSource.prototype,{init:function(t){this.id=$(t).attr("xml:id"),null==this.id&&(this.id=$(t).attr("id")),this.traceFormat=null,this.channelProperties=[];var e=$(t).find("inkml\\:traceFormat, traceFormat");e.length<1&&alert("error: traceFormat is required on inkSource");var n=$(t).find("inkml\\:channelProperties, channelProperties");this.traceFormat=new InkTraceFormat(e,n),this.channels={};var i=this;$(t).find("inkml\\:channelProperty, channelProperty").each(function(){var t=new InkChannelProperty($(this));i.channelProperties.push(t)})},toInkML:function(i){var t=i.createElementNS(c_inkmlNS,"inkml:inkSource"),e=i.createAttributeNS(c_xmlNS,"xml:id");e.nodeValue=this.id,t.setAttributeNode(e);var n=this.traceFormat.toInkML(i);t.appendChild(n);var r=i.createElementNS(c_inkmlNS,"inkml:channelProperties");return t.appendChild(r),$.each(this.channelProperties,function(t,e){var n=e.toInkML(i);r.appendChild(n)}),t}}),InkTimestamp=function(t){this.init(t)},$.extend(InkTimestamp.prototype,{init:function(t){this.id=$(t).attr("xml:id"),null==this.id&&(this.id=$(t).attr("id")),this.timeString=$(t).attr("timeString")},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:timestamp"),n=t.createAttributeNS(c_xmlNS,"xml:id");return n.nodeValue=this.id,e.setAttributeNode(n),e.setAttribute("timeString",this.timeString),e}}),InkTraceFormat=function(t,e){this.init(t,e)},$.extend(InkTraceFormat.prototype,{init:function(t,n){this.id=$(t).attr("xml:id"),null==this.id&&(this.id=$(t).attr("id")),this.channels={};var i=this;$(t).find("inkml\\:channel, channel").each(function(){var t=$(this).attr("name"),e=new InkChannel($(this),n);i.channels[t]=e})},toInkML:function(i){var r=i.createElementNS(c_inkmlNS,"inkml:traceFormat"),t=i.createAttributeNS(c_xmlNS,"xml:id");return t.nodeValue=this.id,r.setAttributeNode(t),$.each(this.channels,function(t,e){var n=e.toInkML(i);r.appendChild(n)}),r}}),InkChannel=function(t,e){this.init(t,e)},$.extend(InkChannel.prototype,{init:function(t,e){this.name=t.attr("name"),this.type=t.attr("type");var n=t.attr("min");this.min=null==n?0:parseFloat(n),this.max=parseFloat(t.attr("max")),this.units=t.attr("units"),this.resolution=0;var i=e.find("inkml\\:channelProperty[channel='"+this.name+"'][name='resolution'], channelProperty[channel='"+this.name+"'][name='resolution']");if(i.length){var r=i.attr("value"),s=i.attr("units");"1/"!=s.substr(0,2)&&alert("error: units of resolution property expected to be 1/unit"),s=s.substring(2),this.units!=s&&alert("error: units of resolution property expected to be same as channel"),this.resolution=r}},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:channel");return e.setAttribute("name",this.name),e.setAttribute("type",this.type),0!=this.min&&e.setAttribute("min",this.min),e.setAttribute("max",this.max),e.setAttribute("units",this.units),e}}),InkChannelProperty=function(t){this.init(t)},$.extend(InkChannelProperty.prototype,{init:function(t){this.channel=t.attr("channel"),this.name=t.attr("name"),this.value=parseFloat(t.attr("value")),this.units=t.attr("units")},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:channelProperty");return e.setAttribute("channel",this.channel),e.setAttribute("name",this.name),e.setAttribute("value",this.value),e.setAttribute("units",this.units),e}}),InkBrush=function(t){this.init(t)},$.extend(InkBrush.prototype,{init:function(t){this.width=10,this.color="#000000",this.brushProperties={};var n=this;$(t).find("inkml\\:brushProperty, brushProperty").each(function(){var t=$(this).attr("name");switch(t){case"color":n.color=$(this).attr("value");break;case"width":n.width=UnitsToHiMetric(parseFloat($(this).attr("value")),$(this).attr("units"))}var e=new InkBrushProperty($(this));n.brushProperties[t]=e})},toInkML:function(i){var r=i.createElementNS(c_inkmlNS,"inkml:brush");return $.each(this.brushProperties,function(t,e){var n=e.toInkML(i);r.appendChild(n)}),r}}),InkBrushProperty=function(t){this.init(t)},$.extend(InkBrushProperty.prototype,{init:function(t){this.name=t.attr("name"),this.value=t.attr("value"),this.units=t.attr("units")},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:brushProperty");return e.setAttribute("name",this.name),e.setAttribute("value",this.value),e.setAttribute("units",this.units),e}}),InkTrace=function(t,e){this.init(t,e)},$.extend(InkTrace.prototype,{init:function(t,e){this.ink=t,this.value=[],this.deriv=[],this.brushRef=e.attr("brushRef"),this.contextRef=e.attr("contextRef"),this.timeOffset=e.attr("timeOffset");for(var n=this,i=e.text().split(","),r=0,s="!";r<i.length;){n.value.push([]),n.deriv.push([]);for(var a=i[r],o="",u=0;u<a.length;){var l=a.charAt(u);isDigit(l)||"."==l?o+=l:0<o.length?(n.value[r].push(parseFloat(o)),n.deriv[r].push(s),"-"==l?o=l:"!"==l||"'"==l||'"'==l?(o="",s=l):o=""):"-"==l?o=l:"!"!=l&&"'"!=l&&'"'!=l||(s=l),u+=1}0<o.length&&(n.value[r].push(parseFloat(o)),n.deriv[r].push(s),o=""),r+=1}for(var h=[],c=0;c<n.value.length;c++)for(var m=0;m<n.value[c].length;m++)"'"==n.deriv[c][m]?(h.push(n.value[c][m]),n.value[c][m]=n.value[c-1][m]+h[m]):'"'==n.deriv[c][m]&&(h[m]+=n.value[c][m],n.value[c][m]=n.value[c-1][m]+h[m]),n.ink.mins.length<=m?n.ink.mins.push(n.value[c][m]):n.ink.mins[m]>n.value[c][m]&&(n.ink.mins[m]=n.value[c][m]),n.ink.maxs.length<=m?n.ink.maxs.push(n.value[c][m]):n.ink.maxs[m]<n.value[c][m]&&(n.ink.maxs[m]=n.value[c][m]),n.ink.sums.length<=m?n.ink.sums.push(n.value[c][m]):n.ink.sums[m]+=n.value[c][m],n.ink.count++},toInkML:function(t){var e=t.createElementNS(c_inkmlNS,"inkml:trace");e.setAttribute("contextRef",this.contextRef),e.setAttribute("brushRef",this.brushRef),e.setAttribute("timeOffset",this.timeOffset);var i="";$.each(this.value,function(t,e){i.length&&(i+=",");var n="";$.each(e,function(t,e){n.length&&(n+=" "),n+=e}),i+=n});var n=t.createTextNode(i);return e.appendChild(n),e}});var HiMetricPerUnit={m:1e5,cm:1e3,mm:100,in:2540,pt:35.27778,pc:424.3333};function HiMetricToUnits(t,e){var n=HiMetricPerUnit[units];return null==n?t:t*(1/n)}function UnitsToHiMetric(t,e){var n=HiMetricPerUnit[e];return null==n?t:t*n}function PixelToHiMetric(t,e){return 2540*t/e}function HiMetricToPixel(t,e){return t*e/2540}